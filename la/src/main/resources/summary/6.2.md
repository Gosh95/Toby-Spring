# 6.2 고립된 단위 테스트

가장 편하고 좋은 테스트 방법은 가능한 한 작은 단위로 쪼개서 테스트하는 것이다.

하지만 작은 단위로 테스트하고 싶어도 그럴 수 없는 경우가 많다. 테스트 대상이 다른 오브젝트와 환경에 의존하고 있다면 작은 단위의 테스트가 주는 장점을 얻기 힘들다.

### 6.2.1 복잡한 의존관계 속의 테스트

UserService의 구현 클래스들이 동작하려면 세 가지 타입의 의존 오브젝트가 필요하다.

- UserDaoJdbc
- DSTransactionManager
- JavaMailSenderImpl

의존 오브젝트는 UserService를 테스트하는 동안 같이 실행된다. 그렇기 때문에 다음과 같은 문제점이 발생한다.

- 테스트를 준비하기 힘들어진다.
- 수행 속도가 느리다.
- 테스트 대상 클래스의 문제가 아님에도 불구하고 의존 오브젝트의 오류로 인해 테스트가 실패할 수 있다.

### 6.2.2 테스트 대상 오브젝트 고립시키기

이와 같은 이유로 테스트의 대상이 환경, 외부 서버, 다른 클래스의 코드에 종속되고 영향을 받지 않도록 고립시킬 필요가 있다.

### 테스트를 위한 UserServiceImpl 고립

UserServiceImpl을 고립된 테스트 방식으로 만들었지만 기능이 수행돼도 그 결과가 DB 등을 통해서 남지 않으니, 기존의 방법으로는 작업 결과를 검증하기 힘들다. 그래서 UserServiceImpl과 그 협력 오브젝트인 UserDao에게 어떤 요청을 했는지를 확인하는 작업이 필요하다.

### 고립된 단위 테스트 활용

고립된 단위 테스트 방법 적용

### UserDao 목 오브젝트

### 테스트 수행 성능의 향상

고립된 테스트를 하면 테스트가 다른 의존 대상에 영향을 받을 경우를 대비해 복잡하게 준비할 필요가 없을 뿐만 아니라, 테스트 수행 성능도 크게 향상된다. 테스트가 빨리 돌아가면 부담 없이 자주 테스트를 돌려볼 수 있다.

### 6.2.3 단위 테스트와 통합 테스트

단위 테스트의 단위는 정하기 나름이다. 중요한 것은 **하나의 단위에 초점을 맞춘 테스트**라는 점이다. 이 책에서는 테스트 대상 클래스를 목 오브젝트 등의 테스트 대역을 이용해 의존 오브젝트나 외부의 리소스를 사용하지 않도록 고립시켜서 테스트하는 것을 **단위 테스트**라고 부른다. 반면에 두 개 이상의 성격이나 계층이 다른 오브젝트가 연동하도록 만들어 테스트하거나, 또는 외부의 DB나 파일, 서비스 등의 리소스가 참여하는 테스트는 **통합 테스트**라고 부르겠다.

그렇다면 단위 테스트와 통합 테스트 중에서 어떤 방법을 쓸지는 어떻게 결정할 것인가? 몇 가지 가이드라인을 살펴보자.

- 항상 단위 테스트를 먼저 고려한다. 
- 외부 리소스를 사용해야만 가능한 테스트는 통합 테스트로 만든다.
- DAO 테스트는 DB라는 외부 리소스를 사용하기 때문에 통합 테스트로 분류된다. 하지만 코드에서 보자면 하나의 기능 단위를 테스트하는 것이기도 하다. DAO를 테스트를 통해 충분히 검증해두면, DAO를 이용하는 코드는 DAO 역할을 스텁이나 목 오브젝트로 대체해서 테스트할 수 있다.
- 단위 테스트를 만들기 복잡하다고 판단되는 경우 처음부터 통합 테스트를 고려해본다. 이때도 통합 테스트에 참여하는 코드 중 많은 부분을 단위 테스트로 검증해두는 게 유리하다.
- 스프링 테스트 컨텍스트 프레임워크를 이용하는 테스트는 통합 테스트다. 가능하면 스프링의 지원 없이 단위 테스트를 하는 게 좋겠지만 스프링의 설정 자체도 테스트 대상이고, 스프링을 이용해 좀 더 추상적인 레벨에서 테스트해야 할 경우도 종종 있다. 이럴 땐 스프링 테스트 컨텍스트 프레임워크를 이용해 통합 테스트를 작성한다.

코드를 작성하면서 테스트는 어떻게 만들 수 있을까를 생각해보는 것은 좋은 습관이다. **테스트하기 편하게 만들어진 코드는 깔끔하고 좋은 코드가 될 가능성이 높다.**

스프링이 지지하고 권장하는 깔끔하고 유연한 코드를 만들다 보면 테스트도 그만큼 만들기 쉬워지고, 테스트는 다시 코드의 품질을 높여주고, 리팩토링과 개선에 대한 용기를 주기도 할 것이다. 반대로 좋은 코드를 만들려는 노력을 게을리하면 테스트 작성이 불편해지고, 테스트를 잘 만들지 않게 될 가능성이 높아진다.

### 6.2.4 목 프레임워크

단위 테스트를 만들기 위해서는 스텁이나 목 오브젝트의 사용이 필수적이다. 의존관계가 없는 단순한 클래스나 세부 로직을 검증하기 위해 메소드 단위로 테스트할 때가 아니라면, 대부분 의존 오브젝트를 필요로 하는 코드를 테스트하게 되기 때문이다.

단위 테스트가 많은 장점이 있고 가장 우선시해야 할 테스트 방법인 건 사실이지만 작성이 번거롭다는 점이 문제다.

다행히도, 이런 번거로운 목 오브젝트를 편리하게 작성하도록 도와주는 다양한 목 오브젝트 지원 프레임워크가 있다.

### Mockito 프레임워크

그중에서도 Mockito라는 프레임워크는 사용하기도 편리하고, 코드도 직관적이라 인기가 많다.

**목 오브젝트 생성**

```java
UserDao mockUserDao = mock(UserDao.class);
```

**스텁 기능 추가**

```java
when(mockUserDao.getAll()).thenReturn(this.users);
```

**호출 검증**
```java
verify(mockUserDao, times(2)).update(any(User.class));
```