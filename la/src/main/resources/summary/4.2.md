## 4.2 예외 전환

예외를 다른 것으로 바꿔서 던지는 예외 전환의 목적은 두 가지다.
- 런타임 예외러 전환하여 불필요한 catch/throws를 줄여주는 것
- 로우레벨의 예외를 좀 더 의미 있고 추상화된 예외로 바꿔서 던져주는 것

### 4.2.1 JDBC의 한계

JDBC는 각 DB 마다 내부 구현이 다르더라도 Connection, Statement, ResultSet 등의 표준 인터페이스를 통해 일관된 방법으로 개발을 할 수 있도록 해준다.

이러한 JDBC API는 DB 프로그램 개발 방법을 학습하는 부담을 확실히 줄여주지만, 현실적으로 DB를 자유롭게 바꾸어 사용할 수 있는 DB 프로그램을 작성하는 데는 두 가지 걸림돌이 있다.

### 비표준 SQL

`첫째 문제는 JDBC 코드에서 사용하는 SQL이다.` SQL은 어느 정도 표준화된 언어이고 몇 가지 표준 규약이 있긴 하지만, 대부분의 DB는 표준을 따르지 않는 비표준 문법과 기능도 제공한다.

특별한 기능을 제공하는 함수를 SQL에 사용하거나 최적화 기법을 적용하는 경우 대부분 비표준 SQL 문장이 만들어진다. `이렇게 작성된 비표준 SQL은 결국 DAO 코드에 들어가고, 해당 DAO는 특정 DB에 대해 종속적인 코드가 되고 만다.` 보통은 DB가 자주 변경되지 않고, 최적화하는 것이 중요하기 때문에 비표준 SQL을 거리낌없이 사용하지만 변경 가능성을 고려햐여 유연하게 만들어야 한다면 SQL은 큰 걸림돌이 된다.

`이 문제의 해결책을 생각해보면, 호환 가능한 표준 SQL만 사용, DB별로 별도의 DAO 생성, SQL을 외부에 독립시켜서 DB에 따라 변경해 사용하는 방법이 있다.`

### 호환성 없는 SQLException의 DB 에러정보

두 번째 문제는 바로 SQLException이다. DB를 사용하다가 발생할 수 있는 예외의 원인은 매우 다양하다.

`문제는 DB마다 SQL만 다른 것이 아니라 에러의 종류와 원인도 제각각이라는 점이다.` 그래서 JDBC는 데이터 처리 중에 발생하는 다양한 예외를 그냥 SQLException 하나에 모두 담아버린다. 이러한 SQLException은 에러 코드 값을 가지는데 이 에러 코드는 DB별로 모두 다르다.

그래서 SQLException은 예외가 발생했을 때의 DB 상태를 담은 SQL 상태정보를 부가적으로 제공한다. 이 상태정보는 DB별로 달라지는 에러 코드를 대신할 수 있도록, Open Group의 XOPEN SQL 스펙에 정의된 SQL 상태 코드를 따르도록 되어 있다.

`하지만 문제는 DB의 JDBC 드라이버에서 SQLException을 담을 상태 코드를 정확하게 만들어주지 않는다는 점이다.` 결과적으로 이 SQL 상태 코드를 믿고 결과를 파악하도록 코드를 작성하는 것은 위험하다.

### 4.2.2 DB 에러 코드 매핑을 통한 전환

DB 종류가 바뀌더라도 DAO를 수정하지 않으려면 이 두 가지 문제를 해결해야 한다.

해결 방법은 DB별 에러 코드를 참고해서 발생한 예외의 원인이 무엇인지 해석해주는 기능을 만드는 것이다. 키 값이 중복돼서 중복 오류가 발생하는 경우에 MySQL이라면 1062, 오라클이라면 1이라는 에러 코드를 받게 된다. 이런 에러 코드 값을 확인할 수 있다면, 키 중복 때문에 발생하는 SQLException을 DuplicatedKeyException이라는 의미가 분명히 드러나는 예외로 전환할 수 있다.

스프링은 DataAccessException이라는 SQLException을 대체할 수 있는 런타임 예외를 정의하고 있을 뿐 아니라 DataAccessException의 서브클래스로 BadSqlGrammarException, DataIntegrityViolationException 이외에도 다양한 예외 클래스를 제공한다.

문제는 DB마다 에러 코드가 제각각이라는 점이다. `스프링은 이를 위해 DB별 에러 코드를 분류해서 예외 클래스와 매핑해놓은 에러 코드 매핑정보 테이블을 만들어두고 매핑정보를 참고해서 적절한 예외 클래스를 선택한다.` 때문에 DB가 달라져도 같은 종류의 에러라면 동일한 예외를 받을 수 있다. 

...

### 4.2.3 DAO 인터페이스와 DataAccessException 계층구조

DataAccessException은 JDBC의 SQLException을 전환하는 용도로만 만들어진 건 아니다. JDBC 외의 자바 데이터 엑세스 기술에서 발생하는 예외에도 적용된다.

DataAccessException은 의미가 같은 예외라면 데이터 엑세스 기술의 종류와 상관없이 일관된 예외가 발생하도록 만들어준다.

### DAO 인터페이스와 구현의 분리

DAO를 굳이 따로 만들어서 사용하는 이유는 무엇일까? 가장 중요한 이유는 `데이터 엑세스 로직을 담은 코드를 성격이 다른 코드에서 분리해놓기 위해서다.` 또한 분리된 DAO는 전략 패턴을 적용해 구현 방법을 변경해서 사용할 수 있게 만들기 위해서이기도 하다.

그런데 DAO의 사용 기술과 구현 코드는 전략 패턴과 DI를 통해서 DAO를 사용하는 클라이언트에게 감출 수 있지만, `메소드 선언에 나타나는 예외정보가 문제가 될 수 있다.`

### 데이터 엑세스 예외 추상화와 DataAccessException 계층구조

스프링은 다양한 데이터 엑세스 기술을 사용할 때 발생하는 예외들을 추상화해서 DataAccessException 계층구조 안에 정리해놓았다.

DataAccessException은 자바의 주요 데이터 엑세스 기술에서 발생할 수 있는 대부분의 예외를 추상화하고 있다. 데이터 엑세스 기술에 상관없이 공통적인 예외뿐 아니라 일부 기술에서만 발생하는 예외도 포함해서 대부분의 예외를 계층구조로 분류해놓았다.

### DataAccessException 활용 시 주의사항

데이터 접근 기술마다 예외를 다르게 처리한다. 예를 들어 기본키가 중복될 경우 JDBC는 DuplicatedKeyException이 발생하지만, 하이버네이트의 경우에는 ConstraintViolationException을 발생시킨다. 그렇기 때문에 DataAccessException이 기술에 상관없이 추상화된 공통 예외로 변환해주기는 하지만 완벽하다고 볼 수는 없다.

